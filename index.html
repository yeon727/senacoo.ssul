<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>세나 쿠폰 자동입력기</title>
</head>
<body>
  <h2>세븐나이츠 쿠폰 자동입력기</h2>
  <div>
    <label>회원번호:</label><br>
    <input type="text" id="memberId" placeholder="회원번호 입력" style="width:300px" />
  </div>
  <div>
    <label>쿠폰 목록 (한 줄씩):</label><br>
    <textarea id="couponList" rows="15" cols="50" placeholder="쿠폰코드를 줄바꿈으로 입력하세요"></textarea>
  </div>
  <button onclick="start()">자동입력 시작</button>

  <h3>입력 결과</h3>
  <div id="log" style="white-space:pre-line; border:1px solid #ccc; padding:10px; height:200px; overflow-y:scroll;"></div>

  <script>
    function logMessage(msg) {
      const log = document.getElementById("log");
      log.textContent += msg + "\n";
      log.scrollTop = log.scrollHeight;
    }

    function start() {
      const memberId = document.getElementById("memberId").value.trim();
      const coupons = document.getElementById("couponList").value.trim().split('\n').filter(c => c.trim());
      if (!memberId || coupons.length === 0) {
        alert("회원번호와 쿠폰 목록을 모두 입력해주세요.");
        return;
      }

      const code = `
        (async function(){
          const memberId = "${memberId}";
          const coupons = ${JSON.stringify(coupons)};
          let i = 0;

          function wait(ms){ return new Promise(r => setTimeout(r, ms)); }

          async function step(){
            const modal = document.querySelector("div[role='dialog']");
            if (modal) {
              const txt = modal.innerText || "";
              const btns = modal.querySelectorAll("button");
              if (txt.includes("쿠폰을 사용하시겠습니까?") && btns.length === 2) {
                btns[1].click();
                window.opener.postMessage({type: "log", text: "✅ " + coupons[i-1] + ": 사용 확인 클릭"}, "*");
              } else {
                btns[0].click();
                window.opener.postMessage({type: "log", text: "⚠️ " + coupons[i-1] + ": " + txt.split("\\n")[0]}, "*");
              }
              await wait(1500);
              return step();
            }

            if (i >= coupons.length) {
              window.opener.postMessage({type: "log", text: "🎉 모든 쿠폰 처리가 완료되었습니다."}, "*");
              return;
            }

            const mi = document.querySelector("input[placeholder*='회원번호']");
            const ci = document.querySelector("input[placeholder*='쿠폰번호']");
            const btn = [...document.querySelectorAll("button")].find(b => b.textContent.includes("사용하기"));

            if (mi && ci && btn) {
              mi.value = memberId;
              mi.dispatchEvent(new Event('input', {bubbles: true}));
              ci.value = coupons[i];
              ci.dispatchEvent(new Event('input', {bubbles: true}));
              btn.click();
              window.opener.postMessage({type: "log", text: "🔄 " + coupons[i] + ": 사용 시도"}, "*");
              i++;
            }

            await wait(1500);
            step();
          }

          step();
        })();
      `;

      const newTab = window.open("https://coupon.netmarble.com/tskgb", "_blank");
      const interval = setInterval(() => {
        if (newTab && newTab.document && newTab.document.readyState === "complete") {
          newTab.eval(code);
          clearInterval(interval);
        }
      }, 1000);
    }

    window.addEventListener("message", (event) => {
      if (event.data?.type === "log") {
        logMessage(event.data.text);
      }
    });
  </script>
</body>
</html>
