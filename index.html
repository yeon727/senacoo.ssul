<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>세나 쿠폰 자동입력기</title>
</head>
<body>
  <h2>세븐나이츠 쿠폰 자동입력기</h2>
  <div>
    <label>회원번호:</label><br>
    <input type="text" id="memberId" placeholder="회원번호 입력" style="width:300px" />
  </div>
  <div>
    <label>쿠폰 목록 (한 줄씩):</label><br>
    <textarea id="couponList" rows="15" cols="50" placeholder="쿠폰코드를 줄바꿈으로 입력하세요"></textarea>
  </div>
  <button onclick="start()">자동입력 시작</button>

  <h3>입력 결과</h3>
  <div id="log" style="white-space:pre-line; border:1px solid #ccc; padding:10px; height:200px; overflow-y:scroll;"></div>

  <script>
    function logMessage(msg) {
      const log = document.getElementById("log");
      log.textContent += msg + "\n";
      log.scrollTop = log.scrollHeight;
    }

    function start() {
      const memberId = document.getElementById("memberId").value.trim();
      const coupons = document.getElementById("couponList").value.trim().split('\n').map(c => c.trim()).filter(c => c);
      if (!memberId || coupons.length === 0) {
        alert("회원번호와 쿠폰 목록을 모두 입력해주세요.");
        return;
      }

      const code = `
        (async function(){
          const memberId = ${JSON.stringify(memberId)};
          const coupons = ${JSON.stringify(coupons)};
          let i = 0;

          function wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

          async function step(){
            const modal = document.querySelector("div[role='dialog']");
            if (modal) {
              const txt = modal.innerText || "";
              const btns = modal.querySelectorAll("button");
              if (txt.includes("쿠폰을 사용하시겠습니까?") && btns.length === 2) {
                btns[1].click();
                window.opener.postMessage({type: "log", text: "✅ " + coupons[i-1] + ": 사용 확인 클릭"}, "*");
              } else if (
                (txt.includes("해당 쿠폰의 교환 횟수를 초과하였습니다.") ||
                txt.includes("이미 보상이 지급된 쿠폰") ||
                txt.includes("회원번호 항목을 확인해 주세요") ||
                txt.includes("사용 기한이 지난 쿠폰") ||
                txt.includes("쿠폰을 다시 확인해 주세요")) && btns.length >= 1
              ) {
                btns[0].click();
                window.opener.postMessage({type: "log", text: "⚠️ " + coupons[i-1] + ": " + txt.split("\\n")[0]}, "*");
              } else if (btns.length === 1) {
                btns[0].click();
                window.opener.postMessage({type: "log", text: "ℹ️ " + coupons[i-1] + ": 확인 클릭"}, "*");
              }
              await wait(1500);
              return step();
            }

            if (i >= coupons.length) {
              window.opener.postMessage({type: "log", text: "🎉 모든 쿠폰 처리가 완료되었습니다."}, "*");
              return;
            }

            const memberInput = document.querySelector("input[placeholder*='회원번호']");
            const couponInput = document.querySelector("input[placeholder*='쿠폰번호']");
            const useBtn = Array.from(document.querySelectorAll("button")).find(b => b.textContent.includes("사용하기"));

            if (memberInput && couponInput && useBtn) {
              memberInput.value = memberId;
              memberInput.dispatchEvent(new Event('input', {bubbles:true}));
              couponInput.value = coupons[i];
              couponInput.dispatchEvent(new Event('input', {bubbles:true}));
              useBtn.click();
              window.opener.postMessage({type: "log", text: "🔄 " + coupons[i] + ": 사용 시도"}, "*");
              i++;
              await wait(1500);
              return step();
            } else {
              window.opener.postMessage({type: "log", text: "❌ 입력창 또는 버튼을 찾을 수 없습니다."}, "*");
              await wait(2000);
              return step();
            }
          }

          step();
        })();
      `;

      const newTab = window.open("https://coupon.netmarble.com/tskgb", "_blank");

      if (!newTab) {
        alert("팝업 차단이 되어 있습니다. 팝업을 허용해주세요.");
        return;
      }

      // 새 탭이 완전히 로드될 때까지 기다렸다가 스크립트 삽입
      const timer = setInterval(() => {
        try {
          if (newTab.document && newTab.document.readyState === "complete") {
            // 스크립트 태그 만들어서 삽입
            const script = newTab.document.createElement("script");
            script.textContent = code;
            newTab.document.body.appendChild(script);
            clearInterval(timer);
          }
        } catch(e) {
          // 크로스 도메인 접근 에러 방지
        }
      }, 1000);
    }

    window.addEventListener("message", (event) => {
      // 보안상 원본 확인 가능 (여기선 편의상 * 로 둠)
      if (event.data?.type === "log") {
        logMessage(event.data.text);
      }
    });
  </script>
</body>
</html>
